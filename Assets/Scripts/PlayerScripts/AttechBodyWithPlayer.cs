using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class AttechBodyWithPlayer : MonoBehaviour
{
    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    public static AttechBodyWithPlayer instance;

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    public static event Action OnAttach;

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    [SerializeField]private Transform player;

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    [SerializeField]private float posSetter = -1f;

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    [SerializeField] private LayerMask bodyLayer;

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    public HashSet<GameObject> hitObjectsThisFrame = new HashSet<GameObject>();

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    private void OnEnable()
    {
        BodyBehaviour.OnBodyDeteched += ChangePos;
    }

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    private void ChangePos()
    {
        transform.localPosition += new Vector3(0f, 1f, 0f);
        posSetter += 1;
    }

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    private void Awake()
    {
        instance = this;
    }

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    void Update()
    {

        BodyCheckRaycast();
    }

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

    private void BodyCheckRaycast()
    {
        RaycastHit hit;

        if (Physics.Raycast(transform.position, -transform.up, out hit, 0.26f, bodyLayer))
        {


            if (hit.collider != null)
            {
                GameObject hitObject = hit.collider.gameObject;

                if (!hitObjectsThisFrame.Contains(hitObject))
                {
                    OnAttach?.Invoke();
                    hitObjectsThisFrame.Add(hitObject);
                    GameManager.Instance.numberOfBlocksAttech++;
                    hit.collider.transform.parent = player.transform;
                    hit.collider.transform.localPosition = new Vector3(0f, posSetter, 0f);
                    transform.localPosition = new Vector3(0f, posSetter, 0f);
                    posSetter -= 1f;

                }
                else
                {
                    //Debug.Log("Already Contain" + hitObject);
                }
               
            }

        }

    }

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//


    private void OnDisable()
    {
        BodyBehaviour.OnBodyDeteched -= ChangePos;
    }

    //--------------------------------------------------------------------------------------------------------------------------------------------//
    //--------------------------------------------------------------------------------------------------------------------------------------------//

}
